/* https://github.com/huguesjohnson/DubbelLib/blob/main/LICENSE */

package com.huguesjohnson.dubbel.retailclerk.build;

import java.io.FileWriter;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;

import com.google.gson.Gson;
import com.huguesjohnson.dubbel.file.FileUtils;
import com.huguesjohnson.dubbel.file.PathResolver;
import com.huguesjohnson.dubbel.retailclerk.build.parameters.XmToEsfParameters;
import com.huguesjohnson.dubbel.retailclerk.build.xmToEsf.XMESFMap;
import com.huguesjohnson.dubbel.retailclerk.build.xmToEsf.XmToEsfConverter;

public class BuildXmToEsf extends BaseBuilder{

	public static void build(String basePath,XmToEsfParameters parameters) throws Exception{
		FileWriter includeWriter=null;
		String currentMapPath=null;
		String includeFilePath=PathResolver.getAbsolutePath(basePath,parameters.includeFilePath);
		//this is needed to set relative paths later
		String includeFileDir=Paths.get(includeFilePath).getParent().toString();
		if(!includeFileDir.endsWith(PathResolver.SEPARATOR)){
			includeFileDir=includeFileDir+PathResolver.SEPARATOR;
		}
		try{
			//setup include writer
			FileUtils.mkdirs(includeFilePath);
			includeWriter=new FileWriter(includeFilePath);
			includeWriter.write("; generated by build tools");
			includeWriter.write(newLine);
			includeWriter.write(newLine);
			for(int mapIndex=0;mapIndex<parameters.mapPaths.length;mapIndex++){
				currentMapPath=PathResolver.getAbsolutePath(basePath,parameters.mapPaths[mapIndex]);
				//read the map
				Path mapPath=Paths.get(currentMapPath);
				String parentPath=mapPath.getParent().toString();
				if(!parentPath.endsWith(PathResolver.SEPARATOR)){
					parentPath=parentPath+PathResolver.SEPARATOR;
				}
				String json=Files.readString(mapPath);
				XMESFMap map=(new Gson()).fromJson(json,XMESFMap.class);
				//convert relative paths to absolute
				map.xmFilePath=PathResolver.getAbsolutePath(parentPath,map.xmFilePath);
				map.esfOutputPath=PathResolver.getAbsolutePath(parentPath,map.esfOutputPath);
				//run the conversion
				XmToEsfConverter.convert(map);
				//update include file
				String incBinPath=PathResolver.getRelativePath(includeFileDir,map.esfOutputPath);
				includeWriter.write(map.label+":"+newLine);
				includeWriter.write("\tincbin\t'"+incBinPath+"'");
				includeWriter.write(newLine);
				includeWriter.write(newLine);
			}
		}catch(Exception x){
			System.err.println("Error in BuildXmToEsf");
			if(currentMapPath==null){
				System.err.println("currentMapPath==null");
			}else{
				System.err.println("currentMapPath="+currentMapPath);
			}
			throw(x);
		}finally{
			try{if(includeWriter!=null){includeWriter.flush();includeWriter.close();}}catch(Exception x){ }
		}
	}
	
}